// полный обновленный скрипт из предыдущего ответа